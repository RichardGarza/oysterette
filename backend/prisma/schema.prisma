// Oysterette App - Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  username          String?  @unique
  password          String?
  profilePhotoUrl   String?

  // OAuth provider IDs (optional)
  googleId  String?  @unique  // Google's unique user ID
  appleId   String?  @unique  // Apple's unique user ID

  // User preferences stored as JSON
  preferences Json?    @default("{}")

  // Reviewer credibility metrics
  credibilityScore  Float   @default(1.0)  // Multiplier for review influence (0.5 to 1.5)
  totalAgrees       Int     @default(0)    // Total "Agree" votes received
  totalDisagrees    Int     @default(0)    // Total "Disagree" votes received
  reviewCount       Int     @default(0)    // Total reviews written

  // Privacy settings
  profileVisibility  String  @default("public")  // "public", "friends", "private"
  showReviewHistory  Boolean @default(true)      // Show reviews on public profile
  showFavorites      Boolean @default(true)      // Show favorites on public profile
  showStatistics     Boolean @default(true)      // Show stats on public profile

  // Baseline flavor profile (for recommendations)
  // User can set this before reviewing, updated with each positive review
  baselineSize           Float?  // Preferred size (1-10)
  baselineBody           Float?  // Preferred body (1-10)
  baselineSweetBrininess Float?  // Preferred sweet/brininess (1-10)
  baselineFlavorfulness  Float?  // Preferred flavorfulness (1-10)
  baselineCreaminess     Float?  // Preferred creaminess (1-10)

  // Flavor profile ranges (calculated from 5+ LIKE_IT/LOVE_IT reviews)
  rangeMinSize           Float?  // Minimum size preference
  rangeMaxSize           Float?  // Maximum size preference
  rangeMedianSize        Float?  // Median size preference
  rangeMinBody           Float?  // Minimum body preference
  rangeMaxBody           Float?  // Maximum body preference
  rangeMedianBody        Float?  // Median body preference
  rangeMinSweetBrininess Float?  // Minimum sweet/brininess preference
  rangeMaxSweetBrininess Float?  // Maximum sweet/brininess preference
  rangeMedianSweetBrininess Float?  // Median sweet/brininess preference
  rangeMinFlavorfulness  Float?  // Minimum flavorfulness preference
  rangeMaxFlavorfulness  Float?  // Maximum flavorfulness preference
  rangeMedianFlavorfulness Float?  // Median flavorfulness preference
  rangeMinCreaminess     Float?  // Minimum creaminess preference
  rangeMaxCreaminess     Float?  // Maximum creaminess preference
  rangeMedianCreaminess  Float?  // Median creaminess preference

  // Relations
  reviews        Review[]
  topOysters     UserTopOyster[]
  votesGiven     ReviewVote[]   @relation("VoterVotes")
  favorites      Favorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Social features
  sentFriendRequests     Friendship[] @relation("FriendRequestSender")
  receivedFriendRequests Friendship[] @relation("FriendRequestReceiver")

  // Gamification / XP System
  xp             Int      @default(0)       // Total experience points earned
  level          Int      @default(1)       // Current level (1-100)
  currentStreak  Int      @default(0)       // Current consecutive review days
  longestStreak  Int      @default(0)       // Longest streak achieved
  lastReviewDate DateTime?                   // Last review submission date (for streak tracking)

  achievements   UserAchievement[]

  @@map("users")
}

// Friendship Model
model Friendship {
  id String @id @default(uuid())

  senderId   String
  sender     User   @relation("FriendRequestSender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("FriendRequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  status     String  @default("pending") // "pending", "accepted", "rejected"

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([senderId, receiverId])
  @@map("friendships")
}

// Oyster Model
model Oyster {
  id             String   @id @default(uuid())
  name           String   @unique
  species        String
  origin         String   // e.g., "Deep Bay"
  standoutNotes  String?  // e.g., "Favorite, dense flavorful"

  // 10-point scale attributes (seed data / baseline)
  size           Int      @default(5)  // 1 (Tiny) to 10 (Huge)
  body           Int      @default(5)  // 1 (Thin) to 10 (Extremely Fat)
  sweetBrininess Int      @default(5)  // 1 (Very Sweet) to 10 (Very Salty)
  flavorfulness  Int      @default(5)  // 1 (Boring) to 10 (Extremely Bold)
  creaminess     Int      @default(5)  // 1 (None) to 10 (Nothing But Cream)

  // Aggregated rating data (calculated from user reviews)
  totalReviews    Int     @default(0)   // Total number of user reviews
  avgRating       Float   @default(0)   // Average rating (LOVED_IT=4, LIKED_IT=3, MEH=2, HATED_IT=1)

  // Aggregated attribute scores (weighted average of seed + user data)
  avgSize           Float?  // Calculated average size rating
  avgBody           Float?  // Calculated average body rating
  avgSweetBrininess Float?  // Calculated average sweet/brininess rating
  avgFlavorfulness  Float?  // Calculated average flavorfulness rating
  avgCreaminess     Float?  // Calculated average creaminess rating

  // Overall weighted score (0-10 scale)
  overallScore    Float   @default(5)   // Weighted combination of all factors

  // Relations
  reviews        Review[]
  topOysterUsers UserTopOyster[]
  favorites      Favorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("oysters")
}

// Review Model
model Review {
  id       String       @id @default(uuid())

  // Relations (userId optional for anonymous reviews)
  userId   String?
  user     User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  oysterId String
  oyster   Oyster       @relation(fields: [oysterId], references: [id], onDelete: Cascade)

  // Overall Rating: Love It, Like It, Meh, Whatever
  rating   ReviewRating

  // 10-point scale sliders (for attribute profile)
  size           Int?     // User's rating 1-10
  body           Int?
  sweetBrininess Int?
  flavorfulness  Int?
  creaminess     Int?

  // Personal notes
  notes    String?

  // Review photos (Cloudinary URLs, max 5)
  photoUrls String[]  @default([])

  // Community voting metrics
  agreeCount     Int      @default(0)    // Total "Agree" votes
  disagreeCount  Int      @default(0)    // Total "Disagree" votes
  netVoteScore   Float    @default(0)    // Weighted: agrees(+1.0) + disagrees(-0.6)
  weightedScore  Float    @default(1.0)  // Final weight multiplier for this review (0.4 to 1.5)

  // Relations
  votes    ReviewVote[]

  createdAt DateTime @default(now())

  @@unique([userId, oysterId])  // One review per user per oyster
  @@map("reviews")
}

// User's Top Oysters (Many-to-Many relationship)
model UserTopOyster {
  id       String @id @default(uuid())

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  oysterId String
  oyster   Oyster @relation(fields: [oysterId], references: [id], onDelete: Cascade)

  rank     Int    // Order in user's top list (1, 2, 3, etc.)

  addedAt  DateTime @default(now())

  @@unique([userId, oysterId])
  @@map("user_top_oysters")
}

// Favorite Model (User's favorited oysters)
model Favorite {
  id       String @id @default(uuid())

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  oysterId String
  oyster   Oyster @relation(fields: [oysterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, oysterId])  // One favorite per user per oyster
  @@map("favorites")
}

// Review Vote Model (Agree/Disagree on reviews)
model ReviewVote {
  id       String   @id @default(uuid())

  // Relations
  userId   String
  voter    User     @relation("VoterVotes", fields: [userId], references: [id], onDelete: Cascade)

  reviewId String
  review   Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Vote type: true = Agree, false = Disagree
  isAgree  Boolean

  createdAt DateTime @default(now())

  @@unique([userId, reviewId])  // One vote per user per review
  @@map("review_votes")
}

// Achievement Model (Badges/Milestones)
model Achievement {
  id          String   @id @default(uuid())
  key         String   @unique  // e.g., "first_review", "10_reviews", "5_regions"
  name        String               // e.g., "Taste Explorer"
  description String               // e.g., "Reviewed 10 oysters"
  icon        String               // Emoji or icon name
  xpReward    Int                  // XP awarded when unlocked

  users       UserAchievement[]

  createdAt   DateTime @default(now())

  @@map("achievements")
}

// User Achievement (Join table with unlock date)
model UserAchievement {
  id            String   @id @default(uuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// Enum for Review Ratings (highest to lowest)
enum ReviewRating {
  LOVE_IT   // 8.0-10.0 → 9.0 (Best)
  LIKE_IT   // 6.0-7.9 → 7.0 (Good)
  OKAY      // 4.0-5.9 → 4.95 (Okay, renamed from WHATEVER)
  MEH       // 1.0-3.9 → 2.5 (Worst)
}
